import streamlit as st
import google.generativeai as genai
import google.ai.generativelanguage as glm
from openai import OpenAI
import os

# ç’°å¢ƒå¤‰æ•°ã‹ã‚‰APIã‚­ãƒ¼ã‚’å–å¾—
OPENAI_API_KEY = os.getenv('OPENAI_API_KEY')
GOOGLE_API_KEY = os.getenv('GOOGLE_API_KEY')

# ãƒšãƒ¼ã‚¸ã®è¨­å®š
st.set_page_config(
    page_title="AI ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ",
    page_icon="ğŸ¤"
)

st.title("ğŸ¤ AI ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ")

# APIé¸æŠ
api_choice = st.selectbox(
    "ä½¿ç”¨ã™ã‚‹AIã‚’é¸æŠã—ã¦ãã ã•ã„:",
    ("OpenAI ChatGPT", "Google Gemini")
)

# APIã‚­ãƒ¼ã®ç¢ºèªã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–
if api_choice == "OpenAI ChatGPT":
    if not OPENAI_API_KEY:
        st.error("OpenAI APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚")
    else:
        client = OpenAI(api_key=OPENAI_API_KEY)
        if "chat_session_openai" not in st.session_state:
            st.session_state["chat_session_openai"] = [
                {"role": "system", "content": "ã‚ãªãŸã¯å„ªç§€ãªAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ã§ãã‚‹ã ã‘ç°¡æ½”ã«å›ç­”ã—ã¦ãã ã•ã„ã€‚"},
                {"role": "assistant", "content": "ã‚ã‹ã‚Šã¾ã—ãŸã€‚"}
            ]
            st.session_state["chat_history_openai"] = []
else:  # Google Gemini
    if not GOOGLE_API_KEY:
        st.error("Google APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚")
    else:
        genai.configure(api_key=GOOGLE_API_KEY)
        if "chat_session_gemini" not in st.session_state:
            model = genai.GenerativeModel('gemini-pro')
            st.session_state["chat_session_gemini"] = model.start_chat(history=[
                glm.Content(role="user", parts=[glm.Part(text="ã‚ãªãŸã¯å„ªç§€ãªAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ã§ãã‚‹ã ã‘ç°¡æ½”ã«å›ç­”ã—ã¦ãã ã•ã„ã€‚")]),
                glm.Content(role="model", parts=[glm.Part(text="ã‚ã‹ã‚Šã¾ã—ãŸã€‚")])
            ])
            st.session_state["chat_history_gemini"] = []

# ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®è¡¨ç¤º
if api_choice == "OpenAI ChatGPT":
    for message in st.session_state.get("chat_history_openai", []):
        with st.chat_message(message["role"]):
            st.markdown(message["content"])
else:
    for message in st.session_state.get("chat_history_gemini", []):
        with st.chat_message(message["role"]):
            st.markdown(message["content"])

# ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›é€ä¿¡å¾Œå‡¦ç†
if prompt := st.chat_input("ã“ã“ã«å…¥åŠ›ã—ã¦ãã ã•ã„"):
    if api_choice == "OpenAI ChatGPT" and OPENAI_API_KEY:
        with st.chat_message("user"):
            st.markdown(prompt)
        st.session_state["chat_history_openai"].append({"role": "user", "content": prompt})
        try:
            response = client.chat.completions.create(
                model="gpt-4",
                messages=st.session_state["chat_session_openai"] + [{"role": "user", "content": prompt}]
            )
            bot_message = response.choices[0].message.content
            st.session_state["chat_session_openai"].append({"role": "user", "content": prompt})
            st.session_state["chat_session_openai"].append({"role": "assistant", "content": bot_message})
        except Exception as e:
            bot_message = f"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}"
        with st.chat_message("assistant"):
            st.markdown(bot_message)
        st.session_state["chat_history_openai"].append({"role": "assistant", "content": bot_message})

    elif api_choice == "Google Gemini" and GOOGLE_API_KEY:
        with st.chat_message("user"):
            st.markdown(prompt)
        st.session_state["chat_history_gemini"].append({"role": "user", "content": prompt})
        try:
            response = st.session_state["chat_session_gemini"].send_message(prompt)
            response_text = response.text
        except Exception as e:
            response_text = f"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}"
        with st.chat_message("assistant"):
            st.markdown(response_text)
        st.session_state["chat_history_gemini"].append({"role": "assistant", "content": response_text})

# ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹ãƒœã‚¿ãƒ³
if st.button("ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ã‚¯ãƒªã‚¢"):
    if api_choice == "OpenAI ChatGPT":
        st.session_state["chat_history_openai"] = []
    else:
        st.session_state["chat_history_gemini"] = []
    st.experimental_rerun()

# APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã®è­¦å‘Š
if not OPENAI_API_KEY and not GOOGLE_API_KEY:
    st.warning("APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚")
